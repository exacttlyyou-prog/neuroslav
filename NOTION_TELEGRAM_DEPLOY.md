# Notion, Telegram и деплой: как это связано

**Статус проверки:** Текст ниже написан по разбору кода и существующих доков. Сценарии (запись, веб, бот, деплой) **не прогонялись** при написании — ни локально, ни на Vercel. Доверять можно только тому, что ты сам перепроверил.

---

## 1. AI Meetings в Notion и наша транскрибация

**Почему мы их не вызываем:** Notion AI Meeting (слэш / → Meeting notes) у нас **не работает стабильно** — по факту это ограничение/баг Notion, починить это извне пока никому не удавалось. Поэтому мы на них не полагаемся.

**Что есть у нас:** своя транскрибация — микрофон + BlackHole, скрипт `record_meeting.py`, кнопки «Начать/Остановить запись» в боте и дашборде. Запись **не стартует автоматом**: пользователь явно запускает её (команда в Telegram, кнопка в вебе или запуск скрипта). Автозапуск записи по какому‑то триггеру сейчас **не реализован**.

---

## 2. Notion = база и витрина, Telegram = оперативка

Целевое разграничение:

- **Telegram-бот** — оперативное общение: команды, запись, саммари, напоминания, быстрые ответы.
- **Notion** — база знаний и витрина: встречи, проекты, люди, глоссарий; всё структурированно, пополняемое и обновляемое.

Сейчас в Notion может быть «мусорка», если туда пишут и вручную, и из разных мест без правил. Чтобы Notion был именно базой/витриной:

1. **Определи одну целевую структуру** в Notion (например: страница «Встречи» с дочерними страницами или база «Встречи»; базы «Люди», «Проекты»; глоссарий).
2. **Наш код пишет в Notion только в известные места:** создание/обновление страниц встреч, задачи, отчёты — через существующие методы `create_meeting_in_db`, `create_task_in_notion`, `save_meeting_summary` и т.п., привязанные к твоим `NOTION_*_ID` в .env.
3. **Читаем оттуда же:** last-meeting, глоссарий, People/Projects — чтобы саммари и контекст были согласованы с «базой».

То есть: Telegram для действий «здесь и сейчас», Notion — куда всё аккуратно складывается и откуда берётся контекст. Дальнейшая настройка — это уже порядок страниц/баз в самом Notion и привязка их в конфиге (NOTION_MEETING_PAGE_ID, NOTION_PEOPLE_DB_ID и т.д.).

---

## 3. Деплой: когда нужен и краткая инструкция

### Когда деплой нужен

**Деплой нужен**, если бот работает через **webhook**:

- В .env задан `TELEGRAM_WEBHOOK_URL`.
- При старте бэкенд вызывает `set_webhook` и Telegram шлёт события на `https://твой-хост/api/telegram/webhook`.
- Без публичного URL webhook не работает → **без деплоя бот из Telegram не отвечает**.

**Деплой не обязателен**, если используешь **polling**:

- Запускаешь локально: `python apps/api/scripts/run_telegram_polling.py` (и бэкенд при необходимости).
- Бот сам опрашивает Telegram; публичный URL не нужен.
- Всё работает на твоей машине, без Vercel/других хостов.

Итого: **для работы только у себя** достаточно polling и локального запуска; **для приёма сообщений из Telegram «из интернета»** (например, с телефона без доступа к твоей сети) нужен деплой и webhook.

---

### Краткая инструкция по деплою (Vercel)

Используй, когда решаешь включить webhook и выставить бота в интернет.

**1. Подготовка**

- Установлен [Vercel CLI](https://vercel.com/cli): `npm i -g vercel`.
- Логин: `vercel login`.
- Репо залит в GitHub (при деплое через Dashboard).

**2. Деплой через Vercel Dashboard**

1. Зайди на [vercel.com](https://vercel.com) → **Add New** → **Project**.
2. Импортируй репо (например `exacttlyyou-prog/neuroslav`).
3. Параметры:
   - **Root Directory:** `./`
   - **Framework:** Other
   - Build/Output/Install — по умолчанию или пусто (по `vercel.json`).
4. **Deploy** → дождись окончания → скопируй URL вида `https://твой-проект.vercel.app`.

**3. Переменные окружения в Vercel**

В проекте: **Settings** → **Environment Variables**. Минимум для бота:

- `TELEGRAM_BOT_TOKEN` — токен от @BotFather  
- `ADMIN_CHAT_ID` — твой chat_id  
- `TELEGRAM_WEBHOOK_URL` — **без** пути, только хост, например: `https://твой-проект.vercel.app`

Остальное по мере надобности: `NOTION_TOKEN`, `NOTION_MEETING_PAGE_ID`, `NOTION_PEOPLE_DB_ID`, `NOTION_PROJECTS_DB_ID`, `DATABASE_URL` и т.д.

**4. Включить webhook**

- Либо оставить как есть: при следующем деплое backend сам вызовет `set_webhook` на `{TELEGRAM_WEBHOOK_URL}/api/telegram/webhook`, если при старте видит и `TELEGRAM_BOT_TOKEN`, и `TELEGRAM_WEBHOOK_URL`.
- Либо один раз вручную:

  ```bash
  cd apps/api && source .venv/bin/activate
  python scripts/setup_telegram_webhook.py https://твой-проект.vercel.app/api/telegram/webhook
  ```

**5. Проверка**

- Напиши боту в Telegram — должен ответить.
- Логи: Vercel → **Deployments** → последний деплой → **Functions** → выбранная функция.

Подробнее — в [DEPLOY_VERCEL.md](DEPLOY_VERCEL.md) и [DEPLOY_STEPS.md](DEPLOY_STEPS.md).

---

## Ошибка «Unexpected response: text/html» и Vercel Security Checkpoint

Если при деплое получаешь `Unexpected response: text/html` и в ответе прилетает страница **«Vercel Security Checkpoint»** / «We're verifying your browser» — запрос к API Vercel вернул HTML (проверку браузера), а не JSON. Так бывает, когда:

- Vercel решает, что запрос «подозрительный», и подставляет страницу верификации;
- в цепочке есть AdGuard / прокси / VPN и ответ на vercel.com подменяется или режется.

**Что сделать по шагам:**

1. **Деплой через браузер (Dashboard), без CLI**
   - Открой [vercel.com](https://vercel.com), залогинься.
   - **Add New** → **Project** → импорт репо (например `exacttlyyou-prog/neuroslav`).
   - Настрой Root Directory, при необходимости переменные — и жми **Deploy** в интерфейсе.
   - Так ты не трогаешь Vercel API из CLI/IDE, и «Unexpected response» обычно не возникает.

2. **Если деплой идёт через GitHub**
   - Просто сделай `git push` в ветку, с которой залинкован проект в Vercel.
   - Деплой запустится автоматически. Ошибка «text/html» чаще всего бывает при вызове Vercel API (CLI, плагин в IDE), а не при самом push.

3. **Если нужен именно CLI (`vercel --prod`)**
   - В том же браузере открой vercel.com и при появлении «Verify your browser» пройди проверку до конца.
   - Выключи AdGuard / блокировщики рекламы и расширения для vercel.com и повтори команду.
   - Можно попробовать из другого браузера или в режиме инкогнито, без расширений.

4. **AdGuard в ответе**
   - В твоём фрагменте ответа есть скрипты с `//local.adguard.org` — значит запрос или ответ мог пройти через AdGuard.
   - Добавь vercel.com в исключения AdGuard или отключи его для вкладки с Vercel / для запросов к vercel.com и задеплой снова (лучше через Dashboard из браузера).
