# План спринта: Автоматизация обработки встреч из Notion

## Цели спринта

1. Автоматизация получения последней встречи из Notion через браузер (Playwright)
2. Интеграция с датасетами Notion (People, Projects, Glossary) для сверки перед отправкой
3. Отправка саммари в Telegram админу (с возможностью отправки на OK)
4. Простой интерфейс для цифровой копии встреч

---

## Задача 1: Скрипт автоматизации Notion через Playwright

### Описание
Скрипт, который автоматически:
- Открывает приложение Notion через браузер (не через API)
- Переходит на страницу встреч (используя `NOTION_MEETING_PAGE_ID`)
- Прокручивает до последнего блока снизу
- Копирует контент последнего блока
- Передает контент дальше в workflow

### Файлы для создания/изменения

1. **`apps/api/app/services/notion_playwright_service.py`** (новый)
   - Класс `NotionPlaywrightService` для автоматизации браузера
   - Методы:
     - `open_notion_app()` - открытие Notion в браузере
     - `navigate_to_meeting_page(page_id)` - переход на страницу встреч
     - `scroll_to_last_block()` - прокрутка до последнего блока
     - `copy_last_block_content()` - копирование контента
     - `get_last_meeting_via_browser(page_id)` - главный метод (объединяет все шаги)

2. **`apps/api/app/routers/notion.py`** (обновить)
   - Добавить endpoint `POST /api/notion/last-meeting/auto`
   - Использовать `NotionPlaywrightService` вместо API

3. **`apps/api/requirements.txt`** (обновить)
   - Добавить `playwright==1.40.0`
   - Добавить `beautifulsoup4==4.12.2` (если нужно для парсинга HTML)

### Технические детали

- Использовать существующий код из `_legacy_archive_v1/integrations/notion_playwright.py` как основу
- Адаптировать под структуру `apps/api`
- Использовать профиль Chrome пользователя для авторизации
- Обработка ошибок авторизации
- Таймауты для загрузки контента

---

## Задача 2: Интеграция с датасетами Notion для сверки

### Описание
Перед отправкой саммари в Telegram нужно:
- Сверять участников встречи с базой "Люди" в Notion
- Проверять упоминания проектов в базе "Проекты"
- Использовать глоссарий для обогащения контекста

### Файлы для изменения

1. **`apps/api/app/services/notion_service.py`** (обновить)
   - Улучшить методы `get_contacts_from_db()`, `get_projects_from_db()`, `get_glossary_from_db()`
   - Добавить метод `verify_participants(participants: List[str])` - сверка участников
   - Добавить метод `verify_projects(mentioned_projects: List[str])` - сверка проектов

2. **`apps/api/app/services/context_loader.py`** (обновить)
   - Улучшить синхронизацию с Notion датасетами
   - Добавить кэширование для быстрого доступа
   - Метод `verify_before_send(analysis: MeetingAnalysis)` - главный метод сверки

3. **`apps/api/app/workflows/meeting_workflow.py`** (обновить)
   - Добавить шаг сверки перед отправкой в Telegram
   - Показывать предупреждения о несовпадениях

### Технические детали

- Использовать существующие методы работы с Notion API
- Кэшировать данные из Notion для быстрого доступа
- Fuzzy matching для имен участников
- Логирование несовпадений

---

## Задача 3: Отправка саммари в Telegram админу

### Описание
После обработки встречи:
1. Отправлять саммари на OK (если указан `OK_CHAT_ID` в .env)
2. Отправлять саммари админу в Telegram (`ADMIN_CHAT_ID`)

### Файлы для изменения

1. **`apps/api/app/config.py`** (обновить)
   - Добавить `ok_chat_id: str | None = None` в Settings

2. **`apps/api/app/services/telegram_service.py`** (обновить)
   - Добавить метод `send_to_ok_chat(message: str)` - отправка на OK
   - Обновить метод `send_notification()` для поддержки разных чатов
   - Метод `send_meeting_summary(analysis: MeetingAnalysis, ok_chat_id: Optional[str] = None)` - главный метод

3. **`apps/api/app/workflows/meeting_workflow.py`** (обновить)
   - Добавить шаг отправки саммари после обработки
   - Сначала на OK (если указан), потом админу

4. **`.env.example`** (обновить)
   - Добавить `OK_CHAT_ID=` (опционально)

### Технические детали

- Использовать тот же Telegram Bot API
- Форматирование саммари в HTML для Telegram
- Обработка ошибок отправки
- Логирование успешных отправок

---

## Задача 4: Простой интерфейс для цифровой копии

### Описание
Создать простой веб-интерфейс для:
- Просмотра последней встречи
- Кнопка "Обработать последнюю встречу" (запускает автоматизацию)
- Просмотр результатов обработки
- Кнопка "Отправить саммари" (с выбором: OK, Админ, Оба)

### Файлы для создания/изменения

1. **`apps/web/app/(tabs)/meetings/page.tsx`** (обновить)
   - Добавить кнопку "Обработать последнюю встречу"
   - Добавить выбор чата для отправки (OK, Админ, Оба)
   - Показывать статус обработки

2. **`apps/web/app/api/notion/last-meeting/auto/route.ts`** (новый)
   - API endpoint для запуска автоматизации
   - Вызывает `POST /api/notion/last-meeting/auto` из FastAPI

3. **`apps/web/components/meetings/MeetingAutoProcess.tsx`** (новый)
   - Компонент для автоматической обработки
   - Кнопки действий
   - Отображение статуса

4. **`apps/api/app/routers/notion.py`** (обновить)
   - Endpoint `POST /api/notion/last-meeting/auto` должен возвращать:
     - Контент последней встречи
     - Результаты обработки (если запущена)
     - Статус отправки

### Технические детали

- Простой UI без излишеств
- Показывать прогресс обработки
- Обработка ошибок с понятными сообщениями
- Возможность отмены операции

---

## Задача 5: Доработка скрипта открытия Notion

### Описание
Улучшить существующий скрипт из `_legacy_archive_v1/integrations/notion_playwright.py`:
- Более надежное определение последнего блока
- Улучшенная обработка динамической загрузки контента
- Поддержка разных типов блоков (transcription, meeting-notes, etc.)

### Файлы для изменения

1. **`apps/api/app/services/notion_playwright_service.py`** (создать на основе legacy)
   - Улучшить метод `scroll_to_last_block()`
   - Добавить ожидание загрузки динамического контента
   - Улучшить метод `copy_last_block_content()` для разных типов блоков

### Технические детали

- Использовать селекторы из legacy кода
- Добавить retry логику
- Улучшить обработку ошибок
- Логирование каждого шага

---

## Порядок выполнения

1. **День 1-2**: Задача 1 (Скрипт автоматизации Notion)
2. **День 2-3**: Задача 5 (Доработка скрипта)
3. **День 3-4**: Задача 2 (Интеграция с датасетами)
4. **День 4-5**: Задача 3 (Отправка в Telegram)
5. **День 5-6**: Задача 4 (Интерфейс)

---

## Зависимости

- Playwright должен быть установлен: `playwright install chromium`
- Chrome профиль должен содержать авторизацию в Notion
- Переменные окружения должны быть настроены:
  - `NOTION_MEETING_PAGE_ID`
  - `ADMIN_CHAT_ID`
  - `OK_CHAT_ID` (опционально)
  - `TELEGRAM_BOT_TOKEN`

---

## Тестирование

1. Тест автоматизации Notion (ручной запуск скрипта)
2. Тест сверки участников с базой "Люди"
3. Тест отправки в Telegram (OK и Админ)
4. Тест интерфейса (обработка последней встречи)

---

## Примечания

- "OK" - возможно, это отдельный чат в Telegram или другой сервис. Нужно уточнить у пользователя.
- Название страницы встреч берется из `NOTION_MEETING_PAGE_ID` в .env
- ID админа берется из `ADMIN_CHAT_ID` в .env (уже есть в проекте)
