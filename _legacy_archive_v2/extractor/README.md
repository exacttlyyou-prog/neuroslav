# Notion Data Extraction Tool

Гибридный инструмент для извлечения текста из блоков "AI Meeting Notes" в Notion. Использует два метода последовательно: сначала официальный Notion API, затем Playwright fallback для случаев, когда API не может получить данные.

## Особенности

- **Гибридный подход**: Сначала пробует Notion API, затем Playwright
- **Автоматическая авторизация**: Использует `NOTION_TOKEN` для автоматического доступа
- **Умная прокрутка**: Автоматически прокручивает страницу для загрузки виртуализированного контента
- **Надежные селекторы**: Использует `data-block-id` и текстовые локаторы вместо хрупких CSS-классов

## Установка

### 1. Установка зависимостей

```bash
cd apps/extractor
npm install
```

### 2. Установка Playwright браузеров

```bash
npx playwright install chromium
```

### 3. Настройка переменных окружения

Создайте файл `.env` в директории `apps/extractor/`:

```bash
# Notion API Token (Internal Integration Token)
NOTION_TOKEN=ntn_...

# Notion Page ID для тестирования (опционально)
NOTION_PAGE_ID=...
```

## Использование

### Базовое использование

```bash
# Извлечение данных для конкретной страницы
node index.js <page_id>

# Или используя переменную окружения
NOTION_PAGE_ID=<page_id> node index.js
```

### Настройка аутентификации (опционально)

Если автоматическая авторизация через `NOTION_TOKEN` не работает, можно использовать ручную настройку:

```bash
node setup-auth.js
```

Скрипт:
1. Откроет браузер в видимом режиме
2. Перейдет на страницу входа Notion
3. Подождет, пока вы вручную войдете (60 секунд)
4. Сохранит состояние сессии в `notion-auth.json`

После этого `extract.js` будет использовать сохраненную сессию как fallback.

## Архитектура

### Метод 1: Notion API

1. Инициализация клиента с токеном из `NOTION_TOKEN`
2. Рекурсивное получение всех блоков страницы через `blocks.children.list()`
3. Поиск блоков с типом `unsupported` или содержащих `plain_text`
4. Извлечение текста из `rich_text` массивов
5. Поиск секций "AI Summary" или "Summary"

### Метод 2: Playwright Fallback

Если API не дал результатов:

1. **Автоматическая авторизация**: Пробует использовать `NOTION_TOKEN` через cookies
2. **Fallback на сессию**: Если токен не работает, использует `notion-auth.json` (если существует)
3. Навигация на страницу Notion
4. Ожидание загрузки (`networkidle` + появление заголовка)
5. **Умная прокрутка**: Прокручивает страницу шагами для загрузки виртуализированного контента
6. Поиск блоков с текстом "AI Summary" или "Summary"
7. Извлечение текста через надежные селекторы

## Структура файлов

```
apps/extractor/
├── package.json          # Зависимости проекта
├── index.js              # Главная точка входа (гибридный подход)
├── extract.js            # Модуль извлечения через Playwright
├── setup-auth.js         # Скрипт для ручной настройки аутентификации (опционально)
├── .env                  # Переменные окружения (не в git)
├── .env.example          # Шаблон переменных окружения
├── notion-auth.json      # Сохраненное состояние сессии (не в git)
└── README.md             # Документация
```

## API

### `extractData(pageId)`

Главная функция для извлечения данных.

**Параметры:**
- `pageId` (string): ID страницы Notion

**Возвращает:**
```javascript
{
  success: boolean,
  content?: string,      // Извлеченный текст
  method?: 'api' | 'playwright',  // Метод, который сработал
  error?: string         // Сообщение об ошибке
}
```

**Пример:**
```javascript
import { extractData } from './index.js';

const result = await extractData('your-page-id');
if (result.success) {
  console.log(result.content);
  console.log(`Метод: ${result.method}`);
}
```

## Интеграция с вебхуками

Инструмент интегрирован с FastAPI backend через вебхук-роутер:

- **Endpoint**: `POST /api/notion/webhook`
- При получении события `page_updated` от Notion автоматически запускается `index.js` для извлечения данных

## Устранение неполадок

### Ошибка: "NOTION_TOKEN не установлен"

Убедитесь, что файл `.env` существует и содержит `NOTION_TOKEN`.

### Ошибка: "Не удалось авторизоваться"

1. Проверьте, что `NOTION_TOKEN` валиден
2. Если токен не работает, запустите `setup-auth.js` для создания сессии

### Ошибка: "Node.js не найден"

Установите Node.js версии 18 или выше:
```bash
# Проверка версии
node -v

# Установка через nvm (рекомендуется)
nvm install 18
nvm use 18
```

### Контент не извлекается

1. Убедитесь, что страница содержит блоки "AI Meeting Notes"
2. Проверьте, что у токена есть доступ к странице
3. Попробуйте запустить `setup-auth.js` для создания сессии браузера

## Лицензия

MIT
