# Настройка аутентификации Notion через Session Replay

Согласно техническому отчету `NOTION_AI_BLOCKS_SOLUTION.md`, для работы с блоками AI Meeting Notes через Playwright необходимо использовать паттерн "Session Replay" вместо программного ввода пароля.

## Быстрый старт

### 1. Настройка сессии (один раз)

Запустите скрипт для ручной настройки аутентификации:

```bash
cd apps/api
python -m app.scripts.setup_notion_auth
```

Скрипт:
1. Откроет браузер в видимом режиме
2. Перейдет на страницу входа Notion
3. Подождет, пока вы вручную войдете (введите пароль, пройдите 2FA)
4. Сохранит состояние сессии в `apps/api/data/notion_auth.json`

### 2. Автоматическое использование

После настройки, `NotionPlaywrightService` автоматически использует сохраненную сессию:

```python
from app.services.notion_playwright_service import NotionPlaywrightService

service = NotionPlaywrightService()
result = await service.get_last_meeting_automatically(page_id="your-page-id")
```

## Как это работает

### Фаза 1: Ручная подготовка (выполняется человеком один раз)
- Браузер открывается в видимом режиме (`headless: false`)
- Пользователь вручную входит в Notion
- Состояние сессии (куки, LocalStorage) сохраняется в JSON-файл

### Фаза 2: Работа робота (выполняется программно)
- Playwright загружает сохраненное состояние сессии
- Notion считает, что это тот же браузер
- Доступ к данным без повторного ввода пароля

## Преимущества

- ✅ Обходит защиту от ботов (Magic Links, SSO, 2FA)
- ✅ Не требует доступа к почтовому ящику
- ✅ Токены сессии живут длительное время
- ✅ Не нужно хранить пароли в коде

## Безопасность

⚠️ **ВАЖНО:** Файл `notion_auth.json` содержит токены сессии и добавлен в `.gitignore`. Не коммитьте его в репозиторий!

## Обновление сессии

Если сессия истекла (Notion требует повторного входа), просто запустите скрипт настройки снова:

```bash
python -m app.scripts.setup_notion_auth
```

## Улучшения согласно отчету

Реализованы следующие улучшения:

1. **Умный скроллинг**: Прокрутка шагами по 800px с ожиданием загрузки чанков данных
2. **Селекторы**: Использование `data-block-id` вместо автогенерируемых классов
3. **Поиск по тексту**: `locator('div').filter({ hasText: 'AI Summary' })`
4. **Виртуализация**: Обработка Lazy Loading контента Notion

## См. также

- `NOTION_AI_BLOCKS_SOLUTION.md` - Полный технический отчет
- `NOTION_PLAYWRIGHT_README.md` - Документация по Playwright интеграции
